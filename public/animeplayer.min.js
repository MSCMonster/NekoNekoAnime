function getAnimeIdFromURL(){const urlParams=new URLSearchParams(window.location.search);return urlParams.get("id")}const animeId=getAnimeIdFromURL();let commentPage=1;const player=new Plyr("video");$(document).ready(()=>{player.source={type:"video",sources:[{src:"/public/placeholder.min.mp4",type:"video/mp4"}]};$.getJSON(`/anime-get-playlog?id=${animeId}`,data=>{if(data.state==="ok"){const playerlogs=new Set(data.data.map(item=>item.file_id));$.getJSON(`/anime-get-data?id=${animeId}`,data=>{if(data.state==="ok"){const animename=data.data.animename;const episodes=data.data.eps;$("#animename").text(animename);$("#web-title").text(animename);episodes.forEach(episode=>{const fileid=episode.id;const epNumber=episode.ep;const url=episode.path;const subtitle_group=episode.subtitle_group;const episodeButton=$('<button type="button" class="btn ep-btn">').text(`${epNumber}`);if(playerlogs.has(fileid)){episodeButton.addClass("played")}episodeButton.click(()=>{$.getJSON(`/animeplaylog?animeid=${animeId}&fileid=${fileid}`,data=>{if(data.state==="ok"){episodeButton.addClass("played");player.source={type:"video",sources:[{src:url,type:"video/mp4"}]};player.play()}else{console.log(data)}})});$("#episodes").append(episodeButton)})}})}});getAnimeAlias();getAnimeComment()});function getAnimeAlias(){$.getJSON(`/anime-get-alias?id=${animeId}`,data=>{$("#alias").empty();data.forEach(alias=>{const aliasButton=$('<button type="button" class="btn ep-btn alias-btn">');aliasButton.text(`${alias.alias}`);aliasButton.click(()=>{$.getJSON(`/anime-rm-alias?id=${animeId}&alias=${alias.alias}`,data=>{if(data.state=="ok"){$("#add-alias-result").text(`删除别称[${alias.alias}]成功`);$("#add-alias-result").css("color","green");getAnimeAlias(animeId)}else{$("#add-alias-result").text(`添加别称[${alias.alias}]失败: ${data.error}`);$("#add-alias-result").css("color","red")}})});$("#alias").append(aliasButton)})})}$("#add-alias-btn").on("click",()=>{const aliasInput=document.getElementById("alias-input");const alias=aliasInput.value;$.getJSON(`/anime-add-alias?id=${animeId}&alias=${alias}`,data=>{if(data.state=="ok"){$("#add-alias-result").text(`添加别称[${alias}]成功`);$("#add-alias-result").css("color","green");getAnimeAlias(animeId)}else{$("#add-alias-result").text(`添加别称[${alias}]失败: ${data.error}`);$("#add-alias-result").css("color","red")}})});function getAnimeComment(){$.getJSON(`/anime-get-comment?id=${animeId}&page=${commentPage}`,data=>{let comment_w=0;data.forEach(comment=>{const textBox=$('<div class="text_main_even"></div>');const commentBox=$('<div class="comment-box"></div>');if(comment_w%2==0){textBox.addClass("text-left")}else{textBox.addClass("text-right")}commentBox.append(`<a class="l">${comment.nickname}</a>`);commentBox.append(`<small class="gery">@${new Date(comment.date).toLocaleString()}</small>`);if(comment.can_del){const delBtn=$(`
                    <button class="delete-button" type="button">
                    <i class="fas fa-trash-alt"></i>删除
                    </button>`);delBtn.on("click",()=>{$.getJSON(`/anime-rm-comment?commentid=${comment.id}`,data=>{if(data.state=="ok"){$("#add-comment-result").text(`删除吐槽成功`);$("#add-comment-result").css("color","green");commentBox.addClass("deleted");setTimeout(()=>{textBox.addClass("deleted")},500)}else{$("#add-comment-result").text(`删除吐槽失败: ${data.error}`);$("#add-comment-result").css("color","red")}})});commentBox.append(delBtn)}commentBox.append(`<p class="comment-content">${comment.comment}</p>`);textBox.append(commentBox);$("#comments").append(textBox);comment_w++})})}$("#add-comment-btn").on("click",()=>{const commentInput=document.getElementById("comment-input");const comment=commentInput.value;const jsonData={comment:comment,animeid:animeId};$.ajax({url:"/anime-add-comment",method:"POST",contentType:"application/json",data:JSON.stringify(jsonData),success:data=>{if(data.state=="ok"){$("#add-comment-result").text(`发表吐槽成功`);$("#add-comment-result").css("color","green");$("#comments").empty();commentInput.value="";getAnimeComment(animeId)}else{$("#add-comment-result").text(`发表吐槽失败: ${data.error}`);$("#add-comment-result").css("color","red")}},error:error=>{console.log("请求错误：",error)}})});